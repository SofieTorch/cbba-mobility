# Offline-First Recording with SQLite and Drizzle

## Architecture Overview

```mermaid
flowchart TB
    subgraph App [React Native App]
        UI[Record Screen]
        RecordService[Recording Service]
        SyncService[Sync Service]
        LocalDB[(SQLite via Drizzle)]
    end
    
    subgraph Backend [FastAPI Server]
        API[REST API]
        PostgresDB[(PostgreSQL)]
    end
    
    UI --> RecordService
    RecordService --> LocalDB
    LocalDB --> SyncService
    SyncService -->|"When online"| API
    API --> PostgresDB
```

## 1. Environment Configuration for API URL

Use `expo-constants` with `app.json` extra config (already available in Expo):

- Add `EXPO_PUBLIC_API_URL` to [app/app.json](app/app.json)
- Update [app/services/api.ts](app/services/api.ts) to read from `Constants.expoConfig.extra`
- For development, run with: `EXPO_PUBLIC_API_URL=http://192.168.x.x:8000 npx expo start`

## 2. SQLite + Drizzle ORM Setup

**Install dependencies:**

- `expo-sqlite` - SQLite for Expo
- `drizzle-orm` - TypeScript ORM
- `drizzle-kit` - Migrations CLI

**New files to create:**

- `app/db/client.ts` - Database connection using expo-sqlite
- `app/db/schema.ts` - Drizzle schema definitions
- `app/db/migrations/` - Migration files

**Local Schema:**

```typescript
// Tables to create:
- localLines       // Cached lines + user-created pending lines
- localSessions    // Recording sessions (synced or pending)
- locationPoints   // GPS data awaiting upload
- sensorReadings   // Sensor data awaiting upload
- syncQueue        // Tracks what needs syncing
```

## 3. Sync Service Architecture

**Sync flow:**

```mermaid
sequenceDiagram
    participant App
    participant LocalDB as SQLite
    participant API as FastAPI
    
    App->>LocalDB: Save location/sensor data
    
    loop Every 30s or on demand
        App->>LocalDB: Get unsynced data
        App->>API: POST batch upload
        alt Success
            App->>LocalDB: Mark as synced
        else Offline/Error
            App->>LocalDB: Keep for retry
        end
    end
```

**New file:** `app/services/sync-service.ts`

- Queue-based sync with retry logic
- Network status detection via `@react-native-community/netinfo`
- Background sync when app is active

## 4. Line Selection and Creation

**Update [app/app/(tabs)/record.tsx](app/app/\(tabs)/record.tsx):**

- Add "Create New Line" button in line selection
- Modal/screen for entering line name and description
- New lines created locally first, synced when online
- Show both server lines and local pending lines

**Add to API client:** `createLine(name, description)` method

## 5. Updated Record Screen Flow

1. **Load lines:** Fetch from API if online, always show local cache
2. **Select or create line:** Pick existing or create new (stored locally)
3. **Start recording:** Create local session (no network required)
4. **Collect data:** Save GPS + sensors to SQLite continuously
5. **Stop recording:** Mark session complete locally
6. **Sync:** Background service uploads when network available

## File Changes Summary

| File | Action |

|------|--------|

| `app/app.json` | Add extra.apiUrl config |

| `app/db/client.ts` | New - SQLite connection |

| `app/db/schema.ts` | New - Drizzle schema |

| `app/services/api.ts` | Update - Use env config |

| `app/services/sync-service.ts` | New - Offline sync logic |

| `app/app/(tabs)/record.tsx` | Update - Offline-first + line creation |

| `app/components/create-line-modal.tsx` | New - Line creation UI |